<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shashka Pro â€” Maksimal Bot (12-daraja)</title>
<style>
:root{--size:min(92vmin,640px);--light:#efe9dd;--dark:#6b8a47;--bg:#f3f5f7}
*{box-sizing:border-box}
body{
    margin:0;
    font-family:Inter,Arial,sans-serif;
    background:linear-gradient(180deg,var(--bg),#eef3f7);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:18px;
    color:#111;
    min-height:100vh;
    overflow-y:auto;
}

h1{margin:8px 0 14px;font-size:1.15rem}
#boardWrap{padding:18px;border-radius:18px;box-shadow:0 20px 50px rgba(17,24,39,0.18)}
#board{
    width:var(--size);
    height:var(--size);
    display:grid;
    grid-template-columns:repeat(8,1fr);
    grid-template-rows:repeat(8,1fr);
    border-radius:10px;
    overflow:hidden;
    position:relative;
}
.cell{display:flex;align-items:center;justify-content:center;position:relative}
.light{background:linear-gradient(180deg,#f9f7ee,#efe9dd)}
.dark{background:linear-gradient(180deg,#6b8a47,#4b6a34)}
.piece{
    width:78%;
    height:78%;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:1.02rem;
    cursor:pointer;
    position:relative;
    z-index:2;
    background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.9),rgba(255,255,255,0.1) 20%),#fff;
    box-shadow:0 8px 20px rgba(0,0,0,0.25),inset 0 -6px 12px rgba(0,0,0,0.05);
    border:1px solid rgba(0,0,0,0.08);
    /* Animatsiya uchun */
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                left 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                top 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
.piece.white{
    background:radial-gradient(circle at 28% 28%,rgba(255,255,255,0.95),rgba(255,255,255,0.8) 18%),linear-gradient(180deg,#ffffff,#f2f2f2);
    color:#111
}
.piece.black{
    background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.12),rgba(255,255,255,0.02) 18%),linear-gradient(180deg,#1b1b1b,#0f0f0f);
    color:#fff
}
.piece.king{
    border:3px solid rgba(245,210,72,0.95);
    box-shadow:0 12px 30px rgba(0,0,0,0.35),0 0 14px rgba(245,210,72,0.08) inset
}
.dot{
    position:absolute;
    width:20%;
    height:20%;
    border-radius:50%;
    background:rgba(255,236,0,0.92);
    z-index:1
}
.selected-outline{
    box-shadow:0 0 0 6px rgba(59,130,246,0.85) inset !important
}
.capture-outline{
    box-shadow:0 0 0 8px rgba(239,68,68,0.9) inset !important
}

/* ==================== YANGI: MAJBURIY OLISH ANIMATSIYASI ==================== */
@keyframes capturePulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes pieceMove {
    0% {
        transform: translate(0, 0) scale(1);
    }
    50% {
        transform: translate(var(--tx, 0), var(--ty, 0)) scale(1.1);
    }
    100% {
        transform: translate(var(--tx, 0), var(--ty, 0)) scale(1);
    }
}

@keyframes pieceCapture {
    0% {
        transform: translate(0, 0) scale(1);
    }
    25% {
        transform: translate(calc(var(--tx, 0) * 0.5), calc(var(--ty, 0) * 0.5)) scale(1.2);
    }
    50% {
        transform: translate(var(--tx, 0), var(--ty, 0)) scale(1.3);
    }
    75% {
        transform: translate(var(--tx, 0), var(--ty, 0)) scale(1.1);
    }
    100% {
        transform: translate(var(--tx, 0), var(--ty, 0)) scale(1);
    }
}

.moving {
    animation: pieceMove 0.6s ease-out forwards;
    z-index: 10 !important;
}

.capturing {
    animation: pieceCapture 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    z-index: 10 !important;
}

.captured-piece {
    animation: capturePulse 0.4s ease-in-out 3;
    opacity: 0.6;
}

/* Mobil uchun modal */
.color-modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.95);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    z-index:10000;
    flex-direction:column;
    color:white;
    text-align:center;
    overflow-y:auto;
    padding:20px 15px 80px;
}
.color-modal h2{
    margin-bottom:25px;
    font-size:1.8rem;
    line-height:1.2;
    margin-top:20px;
}
.color-options{
    display:flex;
    gap:20px;
    margin:20px 0;
    flex-wrap:wrap;
    justify-content:center;
}
.color-option{
    width:90px;
    height:90px;
    border-radius:50%;
    cursor:pointer;
    transition:transform 0.3s;
    border:4px solid transparent;
    flex-shrink:0;
}
.color-option:hover{
    transform:scale(1.05);
}
.color-option.selected{
    border-color:#3b82f6;
    box-shadow:0 0 20px rgba(59,130,246,0.7);
}
.color-white{
    background:radial-gradient(circle at 30% 30%,#ffffff,#f0f0f0);
    border:2px solid #ddd;
}
.color-black{
    background:radial-gradient(circle at 30% 30%,#222,#000);
    border:2px solid #333;
}
.color-random{
    background:linear-gradient(135deg,#fff 50%,#000 50%);
    border:2px solid #666;
}

.start-btn{
    margin:30px auto 20px;
    padding:16px 35px;
    font-size:1.1rem;
    background:#3b82f6;
    color:white;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:bold;
    box-shadow:0 5px 15px rgba(59,130,246,0.4);
    transition:all 0.3s;
    min-width:200px;
    max-width:280px;
    display:block;
}
.start-btn:hover{
    background:#2563eb;
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(59,130,246,0.5);
}

.difficulty-selector{
    margin:20px 0;
    text-align:center;
    width:100%;
    max-width:300px;
}
.difficulty-slider{
    width:100%;
    max-width:300px;
    margin:10px 0;
}
.difficulty-label{
    font-weight:bold;
    margin-top:10px;
    display:block;
    font-size:1rem;
}

#gameOver{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
    pointer-events:none;
    opacity:0;
    transition:opacity .45s
}
#gameOver.show{
    opacity:1;
    pointer-events:all
}
#gameOver div{
    font-size:3.2rem;
    font-weight:900;
    color:#fff;
    padding:22px 36px;
    border-radius:18px;
    background:rgba(0,0,0,0.36);
    text-align:center
}
.win{color:#34d399!important}
.lose{color:#fb7185!important}
.controls{
    display:flex;
    gap:10px;
    margin-top:12px;
    align-items:center;
    flex-wrap:wrap;
    width:100%;
    max-width:var(--size);
    justify-content:center;
}
button{
    padding:10px 18px;
    border-radius:10px;
    border:0;
    background:#2563eb;
    color:#fff;
    cursor:pointer;
    font-weight:700;
    font-size:0.9rem;
}
.info{
    margin-top:12px;
    padding:14px;
    border-radius:12px;
    background:#fff;
    box-shadow:0 6px 18px rgba(2,6,23,0.06);
    width:90vmin;
    max-width:720px
}
.small{font-size:.95rem;color:#333}
.legend{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:10px;
    flex-wrap:wrap;
}
.legend .sw{
    width:18px;
    height:18px;
    border-radius:50%;
    border:1px solid rgba(0,0,0,0.06)
}

@media(max-width:768px){
    body{
        padding:12px;
        min-height:auto;
    }
    
    .color-modal{
        align-items:center;
        justify-content:flex-start;
        padding:30px 15px 100px;
    }
    
    .color-modal h2{
        font-size:1.6rem;
        margin-top:30px;
        margin-bottom:15px;
    }
    
    .modal-content-container{
        display:flex;
        flex-direction:column;
        align-items:center;
        width:100%;
        max-width:100%;
        padding-bottom:20px;
    }
    
    .color-options{
        gap:15px;
        margin:15px 0;
    }
    
    .color-option{
        width:80px;
        height:80px;
    }
    
    .difficulty-selector{
        margin:15px 0;
        max-width:280px;
    }
    
    .difficulty-slider{
        max-width:280px;
    }
    
    .start-btn{
        position:relative;
        bottom:auto;
        left:auto;
        transform:none;
        width:100%;
        max-width:280px;
        margin:25px auto;
        padding:16px;
        font-size:1.1rem;
        z-index:10001;
        box-shadow:0 5px 15px rgba(59,130,246,0.6);
    }
    
    .controls{
        gap:8px;
        padding:0 10px;
    }
    
    button{
        padding:8px 12px;
        font-size:0.85rem;
    }
    
    .info{
        padding:12px;
        margin-top:10px;
    }
}

@media(max-width:480px){
    h1{font-size:1rem}
    .piece{font-size:.88rem}
    #gameOver div{font-size:2.2rem}
    
    .color-modal h2{
        font-size:1.4rem;
        margin-top:20px;
    }
    
    .color-option{
        width:70px;
        height:70px;
    }
    
    .start-btn{
        max-width:250px;
        padding:14px;
        font-size:1rem;
    }
}
</style>
</head>
<body>

<!-- Color Selection Modal -->
<div id="colorModal" class="color-modal">
    <div class="modal-content-container">
        <h2>ðŸŽ® Shashka PRO â€” Maksimal Bot (12-daraja)</h2>
        <p style="font-size:1rem;margin-bottom:15px;color:#ccc;max-width:280px;line-height:1.4;">
            O'ynash uchun rang tanlang:
        </p>
        <div class="color-options">
            <div class="color-option color-white selected" onclick="selectColor('white')" title="Oq rang"></div>
            <div class="color-option color-black" onclick="selectColor('black')" title="Qora rang"></div>
            <div class="color-option color-random" onclick="selectColor('random')" title="Tasodifiy rang"></div>
        </div>
        <p style="margin:15px 0;color:#aaa;font-size:0.9rem;max-width:280px;">
            <strong>Bot darajasi: 12 (MAKSIMUM - yutish qiyin!)</strong>
        </p>
        <p id="colorInfo" style="margin:15px 0;color:#3b82f6;font-weight:bold;font-size:1rem;">
            Siz: Oq | Bot: Qora
        </p>
    </div>
    <button class="start-btn" onclick="startGame()">ðŸŽ® O'yinni Boshlash</button>
</div>

<div id="mainGame" style="display:none;">
    <h1>Shashka â€” Bot (12-daraja)</h1>
    <div id="boardWrap"><div id="board"></div></div>
    <div class="controls">
      <button id="newBtn">Yangi o'yin</button>
      <button id="undoBtn">Orqaga</button>
      <button id="redoBtn" disabled>Oldinga</button>
      <label><input id="autoBot" type="checkbox" checked/> Bot avtomatik</label>
    </div>
    <div class="info">
      <div id="turn" class="small">Navbat: <span id="currentPlayerName">Siz (oq)</span></div>
      <div id="msg" class="small" style="margin-top:6px">Dona tanlang. Majburiy olish.</div>
      <div id="perf" class="small" style="margin-top:6px;color:#555"></div>
      <div class="legend">
          <div class="sw" style="background:#fff"></div>
          <div class="small" id="player1Label">Siz (oq)</div>
          <div class="sw" style="background:#111"></div>
          <div class="small" id="player2Label">Bot (qora)</div>
      </div>
    </div>
    <div id="gameOver"><div id="resultText"></div></div>
</div>

<script>
/* ==================== O'ZGARUVCHILAR ==================== */
const TIME_LIMIT_MS = 1000; // Bot uchun ko'proq vaqt
const boardEl=document.getElementById('board'),newBtn=document.getElementById('newBtn'),
      undoBtn=document.getElementById('undoBtn'),redoBtn=document.getElementById('redoBtn'),
      autoBotCB=document.getElementById('autoBot'),turnEl=document.getElementById('turn'),
      msgEl=document.getElementById('msg'),perfEl=document.getElementById('perf'),
      gameOverEl=document.getElementById('gameOver'),resultTextEl=document.getElementById('resultText'),
      colorModal=document.getElementById('colorModal'),mainGame=document.getElementById('mainGame'),
      difficultySlider=document.getElementById('difficultySlider'),difficultyLabel=document.getElementById('difficultyLabel'),
      colorInfoEl=document.getElementById('colorInfo'),currentPlayerNameEl=document.getElementById('currentPlayerName'),
      player1LabelEl=document.getElementById('player1Label'),player2LabelEl=document.getElementById('player2Label');

let board=[],history=[],historyIndex=0,selected=null,legalMoves=[],playerTurn=true,
    autoBot=true,playerColor='white',botColor='black',
    difficulty=12, // ==================== YANGI: Doimiy 12-daraja ====================
    forceCapture=true, // ==================== YANGI: Faqat majburiy olish ====================
    moveHistory=[],captures={white:0,black:0},historyStack=[],futureStack=[];

/* ==================== YANGI: RANG TANLASH VA KO'RSATISH ==================== */
function selectColor(color){
    if(color==='random'){
        color=Math.random()>0.5?'white':'black';
        playerColor=color;
        botColor=color==='white'?'black':'white';
    }else{
        playerColor=color;
        botColor=color==='white'?'black':'white';
    }
    
    document.querySelectorAll('.color-option').forEach(opt=>opt.classList.remove('selected'));
    event.target.classList.add('selected');
    updateColorInfo();
}

function updateColorInfo(){
    colorInfoEl.textContent=`Siz: ${playerColor==='white'?'Oq':'Qora'} | Bot: ${botColor==='white'?'Oq':'Qora'}`;
    player1LabelEl.textContent=`Siz (${playerColor==='white'?'oq':'qora'})`;
    player2LabelEl.textContent=`Bot (${botColor==='white'?'oq':'qora'})`;
}

function startGame(){
    difficulty=12; // ==================== YANGI: Doimiy 12-daraja ====================
    colorModal.style.display='none';
    mainGame.style.display='block';
    initBoard();
}

/* ==================== ASOSIY FUNKSIYALAR ==================== */
newBtn.onclick=()=>newGame();
undoBtn.onclick=()=>undo();
redoBtn.onclick=()=>redo();
autoBotCB.onchange=()=>{
    autoBot=autoBotCB.checked;
    if(!playerTurn&&autoBot){
        setTimeout(()=>botMoveMAX(),100);
    }
};

difficultySlider.style.display='none'; // ==================== YANGI: Qiyinchilik slider yashirildi ====================
difficultyLabel.textContent='12 - MAKSIMUM (deyarli yutib bo\'lmaydi)'; // ==================== YANGI: Doimiy 12-daraja ====================

function initBoard(){
    board=Array.from({length:8},()=>Array(8).fill(null));
    for(let r=0;r<8;r++)for(let c=0;c<8;c++)if((r+c)%2===1){
        if(r<3)board[r][c]={color:'black',king:false};
        else if(r>4)board[r][c]={color:'white',king:false};
    }
    history=[cloneBoard(board)];historyIndex=0;historyStack=[];futureStack=[];
    selected=null;legalMoves=[];
    playerTurn=playerColor==='white';
    moveHistory=[];captures={white:0,black:0};
    updateTurn();setPerf('');hideGameOver();render();
    
    if(!playerTurn&&autoBot){
        setTimeout(()=>botMoveMAX(),100);
    }
}

function cloneBoard(b){return b.map(row=>row.map(cell=>cell?{color:cell.color,king:cell.king}:null))}
function inBoard(r,c){return r>=0&&r<8&&c>=0&&c<8}
function setMsg(s){msgEl.textContent=s}
function setPerf(s){perfEl.textContent=s}

function updateTurn(){
    if(playerTurn){
        currentPlayerNameEl.textContent=`Siz (${playerColor==='white'?'oq':'qora'})`;
        turnEl.textContent="Navbat: Siz";
    }else{
        currentPlayerNameEl.textContent=`Bot (${botColor==='white'?'oq':'qora'})`;
        turnEl.textContent="Navbat: Bot";
    }
}

function showResult(text,win){resultTextEl.textContent=text;resultTextEl.className=win?"win":"lose";gameOverEl.classList.add("show");setTimeout(()=>hideGameOver(),2100)}
function hideGameOver(){gameOverEl.classList.remove("show")}
function forwardDirsFor(color){return color==='white'?[[-1,1],[-1,-1]]:[[1,1],[1,-1]]}

function continueCaptures(boardState,r,c,visited=new Set()){
    const p=boardState[r][c];if(!p)return[];const color=p.color;let res=[];const dirs=[[1,1],[1,-1],[-1,1],[-1,-1]];
    if(p.king){
        for(const[dR,dC]of dirs){
            let sR=r+dR,sC=c+dC;
            while(inBoard(sR,sC)&&!boardState[sR][sC]){sR+=dR;sC+=dC}
            if(inBoard(sR,sC)&&boardState[sR][sC]&&boardState[sR][sC].color!==color){
                let lR=sR+dR,lC=sC+dC;
                while(inBoard(lR,lC)){
                    if(boardState[lR][lC])break;
                    const key=`${sR},${sC}`;
                    if(visited.has(key)){lR+=dR;lC+=dC;continue}
                    const nb=cloneBoard(boardState);
                    nb[lR][lC]={...nb[r][c],king:true};nb[r][c]=null;nb[sR][sC]=null;
                    const nv=new Set(visited);nv.add(key);
                    const fut=continueCaptures(nb,lR,lC,nv);
                    if(fut.length>0){
                        fut.forEach(f=>res.push({from:[r,c],to:f.to,path:[[r,c],...f.path.slice(1)],captures:[[sR,sC],...f.captures]}))
                    }else res.push({from:[r,c],to:[lR,lC],path:[[r,c],[lR,lC]],captures:[[sR,sC]]});
                    lR+=dR;lC+=dC;
                }
            }
        }
    }else{
        for(const[dR,dC]of dirs){
            const mR=r+dR,mC=c+dC,lR=r+2*dR,lC=c+2*dC;
            if(inBoard(lR,lC)&&boardState[mR][mC]&&boardState[mR][mC].color!==color&&!boardState[lR][lC]){
                const key=`${mR},${mC}`;
                if(visited.has(key))continue;
                const nb=cloneBoard(boardState);
                nb[lR][lC]={...nb[r][c]};nb[r][c]=null;nb[mR][mC]=null;
                if(nb[lR][lC]&&!nb[lR][lC].king){
                    if(nb[lR][lC].color==='white'&&lR===0)nb[lR][lC].king=true;
                    if(nb[lR][lC].color==='black'&&lR===7)nb[lR][lC].king=true;
                }
                const nv=new Set(visited);nv.add(key);
                const fut=continueCaptures(nb,lR,lC,nv);
                if(fut.length>0){
                    fut.forEach(f=>res.push({from:[r,c],to:f.to,path:[[r,c],...f.path.slice(1)],captures:[[mR,mC],...f.captures]}))
                }else res.push({from:[r,c],to:[lR,lC],path:[[r,c],[lR,lC]],captures:[[mR,mC]]});
            }
        }
    }
    return res;
}

function movesFrom(boardState,r,c){
    const p=boardState[r][c];if(!p)return[];let moves=[];
    if(p.king){
        const dirs=[[1,1],[1,-1],[-1,1],[-1,-1]];
        for(const[dR,dC]of dirs){
            let nr=r+dR,nc=c+dC;
            while(inBoard(nr,nc)&&!boardState[nr][nc]){
                moves.push({from:[r,c],to:[nr,nc],path:[[r,c],[nr,nc]],captures:[]});
                nr+=dR;nc+=dC;
            }
        }
    }else{
        const dirs=forwardDirsFor(p.color);
        for(const[dR,dC]of dirs){
            const nr=r+dR,nc=c+dC;
            if(inBoard(nr,nc)&&!boardState[nr][nc])moves.push({from:[r,c],to:[nr,nc],path:[[r,c],[nr,nc]],captures:[]});
        }
    }
    const caps=continueCaptures(boardState,r,c);
    return moves.concat(caps);
}

function allMovesFor(boardState,color){
    let moves=[];
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
        const p=boardState[r][c];
        if(p&&p.color===color)moves=moves.concat(movesFrom(boardState,r,c));
    }
    const caps=moves.filter(m=>m.captures&&m.captures.length>0);
    if(forceCapture&&caps.length>0)return caps;
    return moves;
}

function applyMove(boardState,move){
    const b=cloneBoard(boardState);
    const piece=b[move.from[0]][move.from[1]];
    b[move.from[0]][move.from[1]]=null;
    b[move.to[0]][move.to[1]]=piece;
    if(move.captures&&move.captures.length>0){
        move.captures.forEach(([r,c])=>{
            b[r][c]=null;
            captures[piece.color==='white'?'white':'black']++;
        });
    }
    if(piece&&!piece.king){
        if(piece.color==='white'&&move.to[0]===0)piece.king=true;
        if(piece.color==='black'&&move.to[0]===7)piece.king=true;
    }
    return b;
}

/* ==================== YANGI: ANIMATSIYALI HARAKAT ==================== */
async function animateMove(move,isBot=false){
    const path=move.path||[move.from,move.to];
    const fromPiece=board[move.from[0]][move.from[1]];
    const isKingBefore=fromPiece&&fromPiece.king;
    
    // Olingan donalarni belgilash
    if(move.captures&&move.captures.length>0){
        move.captures.forEach(([r,c])=>{
            const capturedCell=boardEl.children[r*8+c];
            if(capturedCell){
                const capturedPiece=capturedCell.querySelector('.piece');
                if(capturedPiece){
                    capturedPiece.classList.add('captured-piece');
                }
            }
        });
    }
    
    // Harakat animatsiyasi
    for(let i=1;i<path.length;i++){
        const from=path[i-1],to=path[i];
        const fromCell=boardEl.children[from[0]*8+from[1]];
        const pieceEl=fromCell.querySelector('.piece');
        
        if(!pieceEl)continue;
        
        const rf=fromCell.getBoundingClientRect();
        const rt=boardEl.children[to[0]*8+to[1]].getBoundingClientRect();
        const dx=rt.left-rf.left;
        const dy=rt.top-rf.top;
        
        // Animatsiya klassini qo'shish
        pieceEl.style.setProperty('--tx', dx+'px');
        pieceEl.style.setProperty('--ty', dy+'px');
        
        if(move.captures&&move.captures.length>0){
            pieceEl.classList.add('capturing');
            await new Promise(r=>setTimeout(r,800));
            pieceEl.classList.remove('capturing');
        }else{
            pieceEl.classList.add('moving');
            await new Promise(r=>setTimeout(r,600));
            pieceEl.classList.remove('moving');
        }
    }
    
    // Doskani yangilash
    board=applyMove(board,move);
    render();
    
    // Olingan donalarni tozalash
    if(move.captures&&move.captures.length>0){
        setTimeout(()=>{
            move.captures.forEach(([r,c])=>{
                const cell=boardEl.children[r*8+c];
                if(cell){
                    const piece=cell.querySelector('.piece');
                    if(piece)piece.classList.remove('captured-piece');
                }
            });
        }, 800);
    }
    
    // Dama animatsiyasi
    const finalCell=boardEl.children[move.to[0]*8+move.to[1]];
    const finalPiece=finalCell.querySelector('.piece');
    if(finalPiece&&!isKingBefore&&board[move.to[0]][move.to[1]].king){
        finalPiece.style.transform='scale(1.3)';
        setTimeout(()=>{
            finalPiece.style.transform='scale(1)';
            finalPiece.style.transition='transform 0.3s ease';
        }, 300);
    }
}

/* ==================== ORQAGA/OLDINGA FUNKSIYALARI ==================== */
function undo(){
    if(historyIndex<=0)return;
    futureStack.push(cloneBoard(board));
    historyIndex--;
    board=cloneBoard(history[historyIndex]);
    selected=null;legalMoves=[];
    playerTurn=!playerTurn;
    updateUI();
    render();
    setMsg("Orqaga qaytdingiz. 'Oldinga' bilan davom ettiring.");
}

function redo(){
    if(futureStack.length===0)return;
    historyIndex++;
    if(historyIndex>=history.length){
        board=futureStack.pop();
        history.push(cloneBoard(board));
    }else{
        board=cloneBoard(history[historyIndex]);
    }
    selected=null;legalMoves=[];
    playerTurn=!playerTurn;
    updateUI();
    render();
    setMsg("Oldinga qaytdingiz.");
    
    if(!playerTurn&&autoBot){
        setTimeout(()=>botMoveMAX(),100);
    }
}

/* ==================== ASOSIY O'YIN FUNKSIYALARI ==================== */
async function onCellClick(r,c){
    if(!playerTurn)return;
    
    const p=board[r][c];
    
    // Agar dona tanlangan bo'lsa
    if(selected){
        const chosen=legalMoves.find(m=>m.to[0]===r&&m.to[1]===c&&arraysEqual(m.from,selected));
        if(chosen){
            executeMove(chosen);
            return;
        }else{
            selected=null;legalMoves=[];
            render();return;
        }
    }
    
    // Yangi dona tanlash
    if(p&&p.color===playerColor){
        selected=[r,c];
        legalMoves=movesFrom(board,r,c);
        
        // ==================== YANGI: Majburiy olish tekshiruvi ====================
        if(forceCapture){
            const allPossibleMoves = allMovesFor(board, playerColor);
            const captureMoves = allPossibleMoves.filter(m => m.captures && m.captures.length > 0);
            
            if(captureMoves.length > 0){
                const pieceCaptureMoves = legalMoves.filter(m => m.captures && m.captures.length > 0);
                if(pieceCaptureMoves.length === 0){
                    setMsg("Majburiy olish! Bu dona bilan olish mumkin emas.");
                    selected=null;legalMoves=[];
                    return;
                }
                // Faqat olish harakatlarini ko'rsatish
                legalMoves = pieceCaptureMoves;
            }
        }
        
        render();
        const ce=boardEl.children[r*8+c].querySelector('.piece');
        if(ce){
            ce.style.transform='scale(1.2)';
            setTimeout(()=>ce.style.transform='scale(1)', 300);
        }
    }
}

function arraysEqual(a,b){if(!a||!b)return false;if(a.length!==b.length)return false;for(let i=0;i<a.length;i++)if(a[i]!==b[i])return false;return true}

function executeMove(move){
    history=history.slice(0,historyIndex+1);
    const newBoard=applyMove(board,move);
    history.push(cloneBoard(newBoard));
    historyIndex++;
    futureStack=[];
    
    board=newBoard;
    selected=null;legalMoves=[];
    
    // ==================== YANGI: G'ALABA/MAG'LUBIYAT TO'G'RI TEKSHIRISH ====================
    const gameResult = checkEnd();
    if(gameResult){
        endGame(gameResult);
        return;
    }
    
    playerTurn=!playerTurn;
    updateUI();
    render();
    
    if(!playerTurn&&autoBot){
        setTimeout(()=>botMoveMAX(),100);
    }
}

/* ==================== YANGI: G'ALABA/MAG'LUBIYAT FUNKSIYASI ==================== */
function checkEnd(){
    const whiteMoves = allMovesFor(board, 'white');
    const blackMoves = allMovesFor(board, 'black');
    const whitePieces = board.flat().filter(p=>p&&p.color==='white').length;
    const blackPieces = board.flat().filter(p=>p&&p.color==='black').length;
    
    if(whitePieces === 0 || whiteMoves.length === 0){
        return 'black'; // Qora g'alaba
    }
    if(blackPieces === 0 || blackMoves.length === 0){
        return 'white'; // Oq g'alaba
    }
    return null;
}

function endGame(winner){
    playerTurn = false;

    let resultText, isWin;

    if(winner === 'white'){
        // Oq gâ€˜alaba
        if(playerColor === 'white'){
            resultText = "ðŸŽ‰ SIZ YUTDINGIZ!";
            isWin = true;
        }else{
            resultText = "ðŸ¤– BOT YUTDI!";
            isWin = false;
        }
    }else{
        // Qora gâ€˜alaba
        if(playerColor === 'black'){
            resultText = "ðŸŽ‰ SIZ YUTDINGIZ!";
            isWin = true;
        }else{
            resultText = "ðŸ¤– BOT YUTDI!";
            isWin = false;
        }
    }

    showResult(resultText, isWin);
    autoBot = false;
}
function endGame(winner){
    playerTurn = false;

    let resultText, isWin;

    if(winner === 'white'){
        // Oq gâ€˜alaba
        if(playerColor === 'white'){
            resultText = "ðŸŽ‰ SIZ YUTDINGIZ!";
            isWin = true;
        }else{
            resultText = "ðŸ¤– BOT YUTDI!";
            isWin = false;
        }
    }else{
        // Qora gâ€˜alaba
        if(playerColor === 'black'){
            resultText = "ðŸŽ‰ SIZ YUTDINGIZ!";
            isWin = true;
        }else{
            resultText = "ðŸ¤– BOT YUTDI!";
            isWin = false;
        }
    }

    showResult(resultText, isWin);
    autoBot = false;
}
function endGame(winner){
    playerTurn = false;

    let resultText, isWin;

    if(winner === 'white'){
        // Oq gâ€˜alaba
        if(playerColor === 'white'){
            resultText = "ðŸŽ‰ SIZ YUTDINGIZ!";
            isWin = true;
        }else{
            resultText = "ðŸ¤– BOT YUTDI!";
            isWin = false;
        }
    }else{
        // Qora gâ€˜alaba
        if(playerColor === 'black'){
            resultText = "ðŸŽ‰ SIZ YUTDINGIZ!";
            isWin = true;
        }else{
            resultText = "ðŸ¤– BOT YUTDI!";
            isWin = false;
        }
    }

    showResult(resultText, isWin);
    autoBot = false;
}
</script>
</body>
</html>
